<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baro Jarmalka - Erweiterte Version (Deutsch Lernen)</title>
    <meta name="description" content="Interaktive Lernplattform fÃ¼r deutsche Sprache mit somalischen Ãœbersetzungen - Erweiterte Version mit Kategorien">
    <meta name="keywords" content="Deutsch lernen, Somali, Sprache, Vokabeln, Interaktiv">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Baro Jarmalka">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Main Container -->
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">Baro Jarmalka</h1>
            <p class="text-slate-600 text-lg">Deutsch Lernen - Erweiterte Version</p>
        </header>

        <!-- Tutorial Modal -->
        <div id="tutorial-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                <h2 class="text-3xl font-bold mb-4 text-blue-700">Ku soo dhowow!</h2>
                <div class="text-left space-y-4 text-slate-700 mb-8">
                    <p>Kani waa bog kaa caawinaya barashada erayada aasaasiga ah ee Jarmalka.</p>
                    <p>
                        <strong class="text-blue-600">Habka Barashada (Lernmodus):</strong>
                        <br>Halkan waxaad ku arki kartaa kaarar. Riix kaar kasta si aad u aragto tarjumaadda Soomaaliga. Riix astaanta cod-baahiyaha <span class="text-xl">ğŸ”Š</span> si aad u maqasho ku dhawaaqida Jarmalka.
                    </p>
                    <p>
                        <strong class="text-blue-600">Habka Imtixaanka (Testmodus):</strong>
                        <br>Halkan waxaad isku tijaabin kartaa. Eray Jarmal ah ayaa lagu tusi doonaa. Dooro tarjumaadda Soomaaliga ee saxda ah afarta doorasho.
                    </p>
                    <p>
                        <strong class="text-blue-600">Kategoriyada (Kategorien):</strong>
                        <br>Dooro kategoriya aad rabto inaad barato: Guriga, Cunto, Dhar, Qoyska, iyo Midabada.
                    </p>
                </div>
                <button id="start-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-blue-700 transition-colors shadow-lg">Bilow (Start)</button>
            </div>
        </div>
        
        <!-- Category Selection -->
        <div id="category-selection" class="mb-8">
            <h2 class="text-2xl font-bold text-center mb-6">Dooro Kategoriya / WÃ¤hle eine Kategorie</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <button class="category-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all text-center" data-category="haushalt">
                    <div class="text-3xl mb-2">ğŸ </div>
                    <div class="font-semibold">Guriga</div>
                    <div class="text-sm text-slate-500">Haushalt</div>
                </button>
                <button class="category-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all text-center" data-category="essen">
                    <div class="text-3xl mb-2">ğŸ½ï¸</div>
                    <div class="font-semibold">Cunto</div>
                    <div class="text-sm text-slate-500">Essen</div>
                </button>
                <button class="category-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all text-center" data-category="kleidung">
                    <div class="text-3xl mb-2">ğŸ‘•</div>
                    <div class="font-semibold">Dhar</div>
                    <div class="text-sm text-slate-500">Kleidung</div>
                </button>
                <button class="category-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all text-center" data-category="familie">
                    <div class="text-3xl mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                    <div class="font-semibold">Qoyska</div>
                    <div class="text-sm text-slate-500">Familie</div>
                </button>
                <button class="category-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-all text-center" data-category="farben">
                    <div class="text-3xl mb-2">ğŸ¨</div>
                    <div class="font-semibold">Midabada</div>
                    <div class="text-sm text-slate-500">Farben</div>
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div id="progress-container" class="mb-6 hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-slate-600">Fortschritt / Horumar</span>
                <span id="progress-text" class="text-sm font-medium text-slate-600">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Mode Switcher -->
        <div id="mode-switcher" class="flex justify-center mb-8 bg-slate-200 rounded-full p-1 max-w-sm mx-auto hidden">
            <button id="learn-mode-btn" class="w-1/2 py-2 px-4 rounded-full font-semibold transition-colors btn-active">Lernmodus</button>
            <button id="test-mode-btn" class="w-1/2 py-2 px-4 rounded-full font-semibold transition-colors">Testmodus</button>
        </div>

        <!-- Learn Mode Content -->
        <div id="learn-mode">
            <div id="word-cards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Word cards will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Test Mode Content -->
        <div id="test-mode" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg max-w-md mx-auto">
                <div id="test-progress" class="text-right text-slate-500 font-semibold mb-4">Su'aal 1 / 25</div>
                <div class="text-center mb-6">
                    <p class="text-slate-600 mb-1">Waa maxay eraygan?</p>
                    <h2 id="test-word" class="text-4xl font-bold"></h2>
                    <button id="test-audio-btn" class="mt-2 text-3xl text-blue-600 hover:text-blue-800 transition">ğŸ”Š</button>
                </div>
                <div id="test-options" class="grid grid-cols-1 gap-3">
                    <!-- Options will be injected here -->
                </div>
                <div id="test-feedback" class="mt-6 text-center font-bold h-6"></div>
            </div>
             <div id="test-results" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                <h2 class="text-3xl font-bold mb-4">Imtixaankii waa dhammaaday!</h2>
                <p id="results-text" class="text-xl mb-6"></p>
                <div class="flex gap-4 justify-center">
                    <button id="restart-test-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition-colors">Mar kale bilow</button>
                    <button id="back-to-categories-btn" class="bg-slate-600 text-white font-bold py-3 px-6 rounded-full hover:bg-slate-700 transition-colors">Kategoriyada</button>
                </div>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div id="stats-panel" class="fixed bottom-4 right-4 bg-white p-4 rounded-xl shadow-lg hidden">
            <h3 class="font-bold mb-2">Statistiken</h3>
            <div class="text-sm space-y-1">
                <div>Gelernte WÃ¶rter: <span id="learned-words">0</span></div>
                <div>Tests bestanden: <span id="passed-tests">0</span></div>
                <div>Beste Punktzahl: <span id="best-score">0%</span></div>
            </div>
        </div>

    </div>

    <script>
        // Erweiterte Vokabeldaten mit Kategorien
        const vocabularyCategories = {
            haushalt: {
                name: "Haushalt",
                somali: "Guriga",
                words: [
                    { german: 'Toilette', somali: 'Musqul' },
                    { german: 'Sessel', somali: 'Kursi gacan leh' },
                    { german: 'Sofa', somali: 'Fadhi' },
                    { german: 'Treppe', somali: 'Jaranjaro' },
                    { german: 'Regal', somali: 'Raf' },
                    { german: 'Kissen', somali: 'Barkin' },
                    { german: 'Seife', somali: 'Saabuun' },
                    { german: 'Handtuch', somali: 'Tuwaal' },
                    { german: 'Dach', somali: 'Saqaf' },
                    { german: 'Fenster', somali: 'Daaqad' },
                    { german: 'Schlafzimmer', somali: 'Qolka jiifka' },
                    { german: 'Bett', somali: 'Sariir' },
                    { german: 'Bettdecke', somali: 'Gogosha sariirta' },
                    { german: 'KÃ¼hlschrank', somali: 'Talaagad' },
                    { german: 'MÃ¼lleimer', somali: 'Qashin-qub' },
                    { german: 'Keller', somali: 'Maqaasiin' },
                    { german: 'Herd', somali: 'Foorno' },
                    { german: 'Fernseher', somali: 'Telefishin' },
                    { german: 'fernsehen', somali: 'daawashada TV-ga' },
                    { german: 'Schrank', somali: 'Armaajo' },
                    { german: 'Badewanne', somali: 'Biyo-qubeys' },
                    { german: 'Dusche', somali: 'Qubeys' },
                    { german: 'ZÃ¤hne putzen', somali: 'Cadeysasho' },
                    { german: 'ZahnbÃ¼rste', somali: 'Cadey' },
                    { german: 'Zahnpasta', somali: 'Dawaynta ilkaha' }
                ]
            },
            essen: {
                name: "Essen & Trinken",
                somali: "Cunto iyo Cabitaan",
                words: [
                    { german: 'Brot', somali: 'Rooti' },
                    { german: 'Wasser', somali: 'Biyo' },
                    { german: 'Milch', somali: 'Caano' },
                    { german: 'KÃ¤se', somali: 'Kees' },
                    { german: 'Fleisch', somali: 'Hilib' },
                    { german: 'GemÃ¼se', somali: 'Khudaar' },
                    { german: 'Obst', somali: 'Miro' },
                    { german: 'Kaffee', somali: 'Qaxwo' },
                    { german: 'Tee', somali: 'Shaah' },
                    { german: 'Zucker', somali: 'Sonkor' },
                    { german: 'Salz', somali: 'Cusbo' },
                    { german: 'Ã–l', somali: 'Salid' }
                ]
            },
            kleidung: {
                name: "Kleidung",
                somali: "Dhar",
                words: [
                    { german: 'Hose', somali: 'Surwaal' },
                    { german: 'Hemd', somali: 'Shaad' },
                    { german: 'Schuhe', somali: 'Kabaha' },
                    { german: 'Jacke', somali: 'Jaakad' },
                    { german: 'MÃ¼tze', somali: 'Koofiyad' },
                    { german: 'Socken', somali: 'Shariid' },
                    { german: 'UnterwÃ¤sche', somali: 'Shaqsi' },
                    { german: 'Rock', somali: 'Guntiino' },
                    { german: 'Kleid', somali: 'Guntiino' },
                    { german: 'GÃ¼rtel', somali: 'Suun' }
                ]
            },
            familie: {
                name: "Familie",
                somali: "Qoyska",
                words: [
                    { german: 'Mutter', somali: 'Hooyo' },
                    { german: 'Vater', somali: 'Aabbe' },
                    { german: 'Sohn', somali: 'Wiil' },
                    { german: 'Tochter', somali: 'Gabar' },
                    { german: 'Bruder', somali: 'Walaal' },
                    { german: 'Schwester', somali: 'Walaasha' },
                    { german: 'GroÃŸmutter', somali: 'Ayeeyo' },
                    { german: 'GroÃŸvater', somali: 'Awoowe' },
                    { german: 'Onkel', somali: 'Adeer' },
                    { german: 'Tante', somali: 'Eedo' }
                ]
            },
            farben: {
                name: "Farben",
                somali: "Midabada",
                words: [
                    { german: 'Rot', somali: 'Guduud' },
                    { german: 'Blau', somali: 'Buluug' },
                    { german: 'GrÃ¼n', somali: 'Cagaar' },
                    { german: 'Gelb', somali: 'Jaalle' },
                    { german: 'Schwarz', somali: 'Madow' },
                    { german: 'WeiÃŸ', somali: 'Cadaan' },
                    { german: 'Braun', somali: 'Bunni' },
                    { german: 'Grau', somali: 'Grey' },
                    { german: 'Orange', somali: 'Orange' },
                    { german: 'Lila', somali: 'Purple' }
                ]
            }
        };

        // Alle Vokabeln in einem Array fÃ¼r KompatibilitÃ¤t
        const allVocabulary = Object.values(vocabularyCategories).flatMap(category => category.words);

        // --- STATE ---
        let currentTestIndex = 0;
        let score = 0;
        let shuffledVocab = [];
        let currentMode = 'learn';
        let currentCategory = 'haushalt';
        let learnedWords = new Set();
        let testHistory = [];
        let currentVocabulary = [];

        // --- TEXT-TO-SPEECH ---
        let currentSpeechRate = 0.8; // Langsamere Standardgeschwindigkeit
        let wordTestCount = {}; // ZÃ¤hlt wie oft jedes Wort im Test richtig war

        function speak(text, speed = 'normal') {
            if (!window.speechSynthesis) {
                alert("Nidaamka codku kama shaqeynayo biraawsarkan. Fadlan isku day biraawsar kale sida Chrome ama Firefox.");
                return;
            }
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'de-DE';
            
            // Geschwindigkeit einstellen - langsame Stimme noch langsamer
            if (speed === 'slow') {
                utterance.rate = 0.4; // Sehr langsam (vorher 0.6)
                currentSpeechRate = 0.4;
            } else {
                utterance.rate = 0.9; // Normal
                currentSpeechRate = 0.9;
            }
            
            utterance.pitch = 0.7; // Noch tiefer fÃ¼r bessere mÃ¤nnliche Stimme
            utterance.volume = 1.0;
            
            // Verbesserte Stimmenauswahl fÃ¼r bessere VerstÃ¤ndlichkeit
            const voices = window.speechSynthesis.getVoices();
            let bestVoice = null;
            
            // PrioritÃ¤t 1: Deutsche Premium-Stimmen (meist bessere QualitÃ¤t)
            bestVoice = voices.find(voice => 
                voice.lang.startsWith('de') && 
                (voice.name.includes('Premium') || voice.name.includes('HD') || voice.name.includes('High'))
            );
            
            // PrioritÃ¤t 2: Deutsche mÃ¤nnliche Stimmen
            if (!bestVoice) {
                bestVoice = voices.find(voice => 
                    voice.lang.startsWith('de') && 
                    (voice.name.includes('Male') || voice.name.includes('mÃ¤nnlich') || voice.name.includes('male'))
                );
            }
            
            // PrioritÃ¤t 3: Deutsche Stimmen mit guter QualitÃ¤t
            if (!bestVoice) {
                bestVoice = voices.find(voice => 
                    voice.lang.startsWith('de') && 
                    (voice.name.includes('Anna') || voice.name.includes('Markus') || voice.name.includes('Yannick'))
                );
            }
            
            // PrioritÃ¤t 4: Deutsche Stimme (beliebige)
            if (!bestVoice) {
                bestVoice = voices.find(voice => voice.lang.startsWith('de'));
            }
            
            // PrioritÃ¤t 5: Englische Premium-Stimmen
            if (!bestVoice) {
                bestVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    (voice.name.includes('Premium') || voice.name.includes('HD') || voice.name.includes('High'))
                );
            }
            
            // PrioritÃ¤t 6: Englische mÃ¤nnliche Stimme
            if (!bestVoice) {
                bestVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    (voice.name.includes('Male') || voice.name.includes('male'))
                );
            }
            
            if (bestVoice) {
                utterance.voice = bestVoice;
                console.log('Selected voice:', bestVoice.name, 'for language:', bestVoice.lang);
            }
            
            // ZusÃ¤tzliche Verbesserungen fÃ¼r bessere VerstÃ¤ndlichkeit
            utterance.rate = Math.max(0.3, utterance.rate); // Mindestgeschwindigkeit
            utterance.pitch = Math.max(0.5, utterance.pitch); // MindesthÃ¶he
            
            window.speechSynthesis.speak(utterance);
        }

        function speakSlow(text) {
            speak(text, 'slow');
        }

        function speakNormal(text) {
            speak(text, 'normal');
        }

        // Alternative TTS-LÃ¶sung mit besserer QualitÃ¤t
        function speakWithBetterQuality(text, speed = 'normal') {
            // Versuche zuerst die verbesserte Web Speech API
            if (window.speechSynthesis && window.speechSynthesis.getVoices().length > 0) {
                speak(text, speed);
                return;
            }
            
            // Fallback: Verwende Google Translate TTS (falls verfÃ¼gbar)
            try {
                const audio = new Audio();
                const lang = 'de';
                const rate = speed === 'slow' ? '0.4' : '0.9';
                audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${lang}&client=tw-ob&ttsspeed=${rate}`;
                audio.play();
            } catch (error) {
                console.error('Google TTS fallback failed:', error);
                // Letzter Fallback: Verwende Standard-Web Speech API
                speak(text, speed);
            }
        }

        // --- CATEGORY MANAGEMENT ---
        function selectCategory(category) {
            currentCategory = category;
            currentVocabulary = vocabularyCategories[category].words;
            
            // Update UI - Kategorieauswahl bleibt immer sichtbar
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-blue-500');
                btn.classList.add('bg-white');
            });
            
            const selectedBtn = document.querySelector(`[data-category="${category}"]`);
            selectedBtn.classList.remove('bg-white');
            selectedBtn.classList.add('bg-blue-100', 'border-blue-500');
            
            // Show progress and mode switcher (Kategorieauswahl bleibt sichtbar)
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('mode-switcher').classList.remove('hidden');
            
            // Load vocabulary for current mode
            if (currentMode === 'learn') {
                createLearnCards();
            } else {
                startTest();
            }
            
            updateProgress();
        }

        function showCategorySelection() {
            // Kategorieauswahl ist immer sichtbar, nur andere Bereiche verstecken
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('mode-switcher').classList.add('hidden');
            document.getElementById('learn-mode').classList.add('hidden');
            document.getElementById('test-mode').classList.add('hidden');
        }

        // --- PROGRESS TRACKING ---
        function updateProgress() {
            const totalWords = currentVocabulary.length;
            const learnedCount = Array.from(learnedWords).filter(word => 
                currentVocabulary.some(v => v.german === word)
            ).length;
            
            const percentage = Math.round((learnedCount / totalWords) * 100);
            
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;
            
            // Update stats
            document.getElementById('learned-words').textContent = learnedWords.size;
            document.getElementById('passed-tests').textContent = testHistory.length;
            
            const bestScore = testHistory.length > 0 ? Math.max(...testHistory.map(t => t.score)) : 0;
            document.getElementById('best-score').textContent = `${bestScore}%`;
        }

        // --- LEARN MODE ---
        function createLearnCards() {
            const wordCardsContainer = document.getElementById('word-cards');
            wordCardsContainer.innerHTML = '';
            
            currentVocabulary.forEach((word, index) => {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'perspective-1000 fade-in';
                cardContainer.style.animationDelay = `${index * 0.05}s`;

                const card = document.createElement('div');
                card.className = 'card relative w-full h-32 md:h-36 cursor-pointer';
                
                const isLearned = learnedWords.has(word.german);
                const learnedClass = isLearned ? 'ring-2 ring-green-500' : '';
                
                // Front face (German)
                const frontFace = document.createElement('div');
                frontFace.className = `card-face absolute w-full h-full bg-white rounded-xl shadow-md flex flex-col items-center justify-center p-2 text-center ${learnedClass}`;
                frontFace.innerHTML = `
                    <p class="text-lg md:text-xl font-semibold">${word.german}</p>
                    <div class="flex gap-1 mt-1">
                        <button class="speak-slow-btn text-xl text-green-500 hover:text-green-700 transition" aria-label="Maqal si tartiib ah ${word.german}" title="Sehr langsam">ğŸŒ</button>
                        <button class="speak-normal-btn text-xl text-blue-500 hover:text-blue-700 transition" aria-label="Maqal caadi ah ${word.german}" title="Normal">ğŸ”Š</button>
                    </div>
                    ${isLearned ? '<div class="text-green-500 text-sm mt-1">âœ“ Gelernt (5x richtig)</div>' : 
                      wordTestCount[word.german] ? `<div class="text-blue-500 text-sm mt-1">${wordTestCount[word.german]}/5 richtig</div>` : ''}
                `;
                
                // Back face (Somali)
                const backFace = document.createElement('div');
                backFace.className = 'card-face card-face-back absolute w-full h-full bg-blue-600 text-white rounded-xl shadow-md flex items-center justify-center p-2 text-center';
                backFace.innerHTML = `<p class="text-lg md:text-xl font-semibold">${word.somali}</p>`;

                card.appendChild(frontFace);
                card.appendChild(backFace);
                cardContainer.appendChild(card);
                wordCardsContainer.appendChild(cardContainer);

                // Event Listeners for card
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('speak-slow-btn')) {
                        e.stopPropagation();
                        speak(word.german, 'slow');
                    } else if (e.target.classList.contains('speak-normal-btn')) {
                        e.stopPropagation();
                        speak(word.german, 'normal');
                    } else {
                        card.classList.toggle('is-flipped');
                        // WÃ¶rter werden NICHT mehr als gelernt markiert beim Aufdecken
                        // Nur noch beim Testen mit mindestens 5x richtig
                    }
                });
                
                // Keyboard accessibility
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.classList.toggle('is-flipped');
                        // WÃ¶rter werden NICHT mehr als gelernt markiert beim Aufdecken
                    }
                });
            });
        }

        // --- TEST MODE ---
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[i], shuffled[j]];
            }
            return shuffled;
        }

        function startTest() {
            currentTestIndex = 0;
            score = 0;
            shuffledVocab = shuffleArray([...currentVocabulary]);
            document.getElementById('test-results').classList.add('hidden');
            document.querySelector('#test-mode .bg-white').style.display = 'block';
            loadQuestion();
        }

        function loadQuestion() {
            if (currentTestIndex >= shuffledVocab.length) {
                showResults();
                return;
            }

            document.getElementById('test-progress').textContent = `Su'aal ${currentTestIndex + 1} / ${shuffledVocab.length}`;
            const currentWord = shuffledVocab[currentTestIndex];
            document.getElementById('test-word').textContent = currentWord.german;
            document.getElementById('test-feedback').textContent = '';

            // Get options
            const correctAnswer = currentWord.somali;
            let options = [correctAnswer];
            
            // Get 3 random wrong answers from all categories
            const allWords = Object.values(vocabularyCategories).flatMap(cat => cat.words);
            const wrongAnswers = allWords
                .filter(v => v.somali !== correctAnswer)
                .map(v => v.somali);
            
            shuffleArray(wrongAnswers);
            options.push(...wrongAnswers.slice(0, 3));
            
            // Shuffle the final options
            options = shuffleArray(options);

            // Display options
            const testOptionsContainer = document.getElementById('test-options');
            testOptionsContainer.innerHTML = '';
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full text-left bg-slate-100 p-4 rounded-lg hover:bg-slate-200 transition-colors font-medium focus:outline-none focus:ring-2 focus:ring-blue-500';
                button.textContent = option;
                button.setAttribute('aria-label', `Doorasho ${index + 1}: ${option}`);
                button.onclick = () => checkAnswer(option, correctAnswer, button);
                testOptionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedAnswer, correctAnswer, button) {
            const buttons = document.querySelectorAll('#test-options button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-slate-200');
            });

            if (selectedAnswer === correctAnswer) {
                score++;
                
                // ZÃ¤hle wie oft dieses Wort richtig war
                const currentWord = shuffledVocab[currentTestIndex];
                if (currentWord) {
                    wordTestCount[currentWord.german] = (wordTestCount[currentWord.german] || 0) + 1;
                    
                    // Markiere als gelernt wenn mindestens 5x richtig
                    if (wordTestCount[currentWord.german] >= 5) {
                        learnedWords.add(currentWord.german);
                        console.log(`Wort "${currentWord.german}" als gelernt markiert (${wordTestCount[currentWord.german]}x richtig)`);
                    }
                }
                
                document.getElementById('test-feedback').textContent = 'Sax! ğŸ‘';
                document.getElementById('test-feedback').className = 'mt-6 text-center font-bold h-6 text-green-600';
                button.classList.remove('bg-slate-100');
                button.classList.add('bg-green-500', 'text-white');
            } else {
                document.getElementById('test-feedback').textContent = 'Khalad! ğŸ‘';
                document.getElementById('test-feedback').className = 'mt-6 text-center font-bold h-6 text-red-600';
                button.classList.remove('bg-slate-100');
                button.classList.add('bg-red-500', 'text-white');
                
                buttons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.remove('bg-slate-100');
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                });
            }

            currentTestIndex++;
            setTimeout(loadQuestion, 1500);
        }

        function showResults() {
            document.querySelector('#test-mode .bg-white').style.display = 'none';
            document.getElementById('test-results').classList.remove('hidden');
            
            const percentage = Math.round((score / shuffledVocab.length) * 100);
            
            // Save test result
            testHistory.push({
                category: currentCategory,
                score: percentage,
                date: new Date().toISOString(),
                totalQuestions: shuffledVocab.length,
                correctAnswers: score
            });
            
            let resultMessage = '';
            
            if (percentage >= 90) {
                resultMessage = `Waxa aad si sax ah uga jawaabtay ${score} ka mid ah ${shuffledVocab.length} su'aalood. Waad mahadsantahay! ğŸ‰`;
            } else if (percentage >= 70) {
                resultMessage = `Waxa aad si sax ah uga jawaabtay ${score} ka mid ah ${shuffledVocab.length} su'aalood. Waa wanaagsan! ğŸ‘`;
            } else if (percentage >= 50) {
                resultMessage = `Waxa aad si sax ah uga jawaabtay ${score} ka mid ah ${shuffledVocab.length} su'aalood. Siyaad baro! ğŸ“š`;
            } else {
                resultMessage = `Waxa aad si sax ah uga jawaabtay ${score} ka mid ah ${shuffledVocab.length} su'aalood. Siyaad isku day! ğŸ’ª`;
            }
            
            document.getElementById('results-text').textContent = resultMessage;
            
            // WÃ¶rter werden nur als gelernt markiert wenn sie 5x richtig waren (nicht mehr hier)
            // Das passiert jetzt in checkAnswer() fÃ¼r jedes einzelne Wort
            
            updateProgress();
            saveProgress();
        }

        // --- MODE SWITCHING ---
        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'learn') {
                document.getElementById('learn-mode').classList.remove('hidden');
                document.getElementById('test-mode').classList.add('hidden');
                document.getElementById('learn-mode-btn').classList.add('btn-active');
                document.getElementById('test-mode-btn').classList.remove('btn-active');
                
                if (currentVocabulary.length > 0) {
                    createLearnCards();
                }
            } else {
                document.getElementById('learn-mode').classList.add('hidden');
                document.getElementById('test-mode').classList.remove('hidden');
                document.getElementById('learn-mode-btn').classList.remove('btn-active');
                document.getElementById('test-mode-btn').classList.add('btn-active');
                
                if (currentVocabulary.length > 0) {
                    startTest();
                }
            }
        }

        // --- UTILITY FUNCTIONS ---
        function saveProgress() {
            const progress = {
                mode: currentMode,
                category: currentCategory,
                learnedWords: Array.from(learnedWords),
                testHistory: testHistory,
                wordTestCount: wordTestCount,
                lastPlayed: new Date().toISOString()
            };
            localStorage.setItem('baroJarmalkaProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('baroJarmalkaProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    currentMode = progress.mode || 'learn';
                    currentCategory = progress.category || 'haushalt';
                    learnedWords = new Set(progress.learnedWords || []);
                    testHistory = progress.testHistory || [];
                    wordTestCount = progress.wordTestCount || {};
                    currentVocabulary = vocabularyCategories[currentCategory].words;
                    return progress;
                } catch (e) {
                    console.error('Error loading progress:', e);
                }
            }
            return null;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing application...');
            
            // Initialize speech synthesis
            if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = () => {
                    console.log('Speech synthesis voices available');
                };
            }
            
            // Start button event listener
            const startBtn = document.getElementById('start-button');
            if (startBtn) {
                console.log('Start button found, adding event listener...');
                startBtn.addEventListener('click', () => {
                    console.log('Start button clicked!');
                    document.getElementById('tutorial-modal').style.display = 'none';
                    document.getElementById('category-selection').classList.remove('hidden');
                });
            } else {
                console.error('Start button not found!');
            }
            
            // Category selection
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const category = btn.dataset.category;
                    selectCategory(category);
                });
            });
            
            // Mode switching
            document.getElementById('learn-mode-btn').addEventListener('click', () => switchMode('learn'));
            document.getElementById('test-mode-btn').addEventListener('click', () => switchMode('test'));
            
            // Test audio button
            document.getElementById('test-audio-btn').addEventListener('click', () => {
                if (shuffledVocab[currentTestIndex]) {
                    speak(shuffledVocab[currentTestIndex].german, 'normal');
                }
            });
            
            // Test buttons
            document.getElementById('restart-test-btn').addEventListener('click', startTest);
            document.getElementById('back-to-categories-btn').addEventListener('click', showCategorySelection);
            
            // Show stats panel
            document.getElementById('stats-panel').classList.remove('hidden');
            
            // Load saved progress
            const progress = loadProgress();
            if (progress && progress.category) {
                selectCategory(progress.category);
            }
            
            console.log('Application initialized successfully!');
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
